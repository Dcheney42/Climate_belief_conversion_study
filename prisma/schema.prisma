// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Session {
  id            String    @id @default(cuid())
  participantId String?
  startedAt     DateTime?
  completedAt   DateTime?
  appVersion    String?
  raw           Json      // Stores the complete session JSON
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  // Relations
  messages              Message[]
  individualDifferences IndividualDifferences?
  conversationStates    ConversationState[]
  
  @@map("sessions")
}

model Message {
  id        String    @id @default(cuid())
  sessionId String
  turn      Int?
  role      String?   // "user", "assistant", "system"
  content   String?
  timestamp DateTime?
  tokensIn  Int?
  tokensOut Int?
  
  // Relations
  session Session @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  
  @@index([sessionId])
  @@map("messages")
}

model IndividualDifferences {
  id                String  @id @default(cuid())
  sessionId         String  @unique
  raw               Json    // Stores the original nested participant object
  
  // Denormalized columns for common queries
  political7        Int?    // Political orientation (1-7 scale)
  confidence0_100   Int?    // Confidence level (0-100)
  age               Int?
  gender            String?
  education         String?
  viewsChanged      String? // "Yes", "No"
  
  // NEW: Core belief change fields
  mindChangeDirection String? // Radio button selection for belief change direction
  mindChangeNoChange Boolean @default(false) // "My views have not changed" option
  mindChangeOtherText String? // Free text when "Other" is selected
  
  // NEW: Climate change skepticism scale key scores
  ccsMeanScored     Float?  // Overall CCS mean score
  ccsOccurrenceMean Float?  // CCS occurrence subscale mean
  ccsCausationMean  Float?  // CCS causation subscale mean
  ccsSeriousnessMean Float? // CCS seriousness subscale mean
  ccsEfficacyMean   Float?  // CCS efficacy subscale mean
  ccsTrustMean      Float?  // CCS trust subscale mean
  
  // NEW: Political views
  economicIssues    Int?    // Economic political orientation (1-7 scale)
  socialIssues      Int?    // Social political orientation (1-7 scale)
  
  // NEW: AI Summary fields
  aiSummary         String? // AI-generated summary of participant views
  aiSummaryAccuracy String? // Participant's rating of AI summary accuracy
  aiConfidenceSlider Int?   // Participant's confidence in AI summary (0-100)
  
  // NEW: Survey completion tracking
  surveyCompleted   Boolean @default(false)
  completedAt       DateTime?
  prolificId        String? // Prolific participant ID
  
  // Relations
  session Session @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  
  @@map("individual_differences")
}

model ConversationState {
  id            String   @id @default(cuid())
  conversationId String  @unique
  sessionId      String?
  stage          String   @default("exploration") // exploration, elaboration, recap, complete
  turnCount      Int      @default(0)
  topicTurnCount Int      @default(0)
  lastTopic      String?
  minimalResponseCount   Int @default(0)
  substantiveResponseCount Int @default(0)
  exhaustionSignals      Int @default(0)
  lastUserResponse       String?
  metadata       Json?    // Additional state data
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  
  // Relations
  session        Session? @relation(fields: [sessionId], references: [id])
  
  @@map("conversation_states")
}