<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Climate Change Conversation</title>
    <link rel="stylesheet" href="/messenger-styles.css">
</head>
<body>
    <div class="chat-container">
        <div class="chat-header">
            <div class="chat-title">
                <h1>Climate Change Conversation</h1>
                <p>You are now in conversation with an AI assistant</p>
            </div>
            
            <div class="timer-display">
                <div class="timer-circle">
                    <span id="timeRemaining">10:00</span>
                </div>
                <p>Time Remaining</p>
            </div>
        </div>
        
        <div class="chat-main">
            <div class="chat-messages" id="chatMessages">
                <div class="system-message">
                    <div class="message-content">Conversation started. You have 10 minutes to chat.</div>
                </div>
            </div>
            
            <div class="chat-input-area">
                <div class="input-container">
                    <textarea id="messageInput" placeholder="Type your message here..." rows="1" disabled></textarea>
                    <div class="input-controls">
                        <button id="sendButton" class="btn-primary" disabled>Send</button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="chat-status">
            <span id="connectionStatus" class="status-connected">Connected</span>
        </div>
    </div>
    
    <!-- Conversation End Modal -->
    <div id="endModal" class="modal" style="display: none;">
        <div class="modal-content">
            <h2>Conversation Ended</h2>
            <p id="endReason">Your 10-minute conversation has ended.</p>
            <p>Thank you for participating! You will now be redirected to a brief exit survey.</p>
            <button id="continueBtn" class="btn-primary">Continue to Exit Survey</button>
        </div>
    </div>

    <script>
        let conversationId = null;
        let participantId = null;
        let conversationActive = false;
        let timeRemaining = 600; // 10 minutes in seconds
        let timerInterval = null;
        
        // DOM elements
        const chatMessages = document.getElementById('chatMessages');
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        const timeDisplay = document.getElementById('timeRemaining');
        const endModal = document.getElementById('endModal');
        const connectionStatus = document.getElementById('connectionStatus');
        
        // Get participant ID from URL or session storage
        function getParticipantId() {
            // Try to get from URL path first (e.g., /chat/participant-id)
            const pathParts = window.location.pathname.split('/');
            if (pathParts.length >= 3 && pathParts[1] === 'chat') {
                return pathParts[2];
            }
            
            // Fallback to session storage
            return sessionStorage.getItem('participant_id');
        }
        
        // Initialize conversation
        async function initializeConversation() {
            participantId = getParticipantId();
            
            if (!participantId) {
                alert('Invalid session. Please start the study again.');
                window.location.href = '/';
                return;
            }
            
            try {
                // Start conversation with the API
                const response = await fetch('/api/conversations/start', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ participantId })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                conversationId = data.conversationId;
                conversationActive = true;
                
                // Enable input and start timer
                messageInput.disabled = false;
                messageInput.placeholder = "Type your message here...";
                updateSendButtonState();
                startTimer();
                
                // Add opening assistant message
                addMessage({
                    role: 'assistant',
                    content: 'To start: could you describe what led you to change your mind about climate change?',
                    timestamp: new Date().toISOString()
                });
                
                connectionStatus.textContent = 'Connected';
                connectionStatus.className = 'status-connected';
                
            } catch (error) {
                console.error('Error starting conversation:', error);
                connectionStatus.textContent = 'Connection Error';
                connectionStatus.className = 'status-disconnected';
                alert('Error starting conversation. Please try again.');
            }
        }
        
        // Timer functions
        function updateTimer() {
            if (timeRemaining <= 0) {
                endConversation('time_limit');
                return;
            }
            
            const minutes = Math.floor(timeRemaining / 60);
            const seconds = timeRemaining % 60;
            timeDisplay.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            
            // Warning colors
            if (timeRemaining <= 30) {
                timeDisplay.style.color = '#ff4444';
            } else if (timeRemaining <= 120) {
                timeDisplay.style.color = '#ff8800';
            }
            
            timeRemaining--;
        }
        
        function startTimer() {
            timerInterval = setInterval(updateTimer, 1000);
        }
        
        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
        }
        
        // Message functions
        function addMessage(message) {
            const messageDiv = document.createElement('div');
            const isUser = message.role === 'user';
            messageDiv.className = `message ${isUser ? 'own-message' : 'other-message'}`;
            
            const timestamp = new Date(message.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            const senderName = isUser ? 'You' : 'Assistant';
            
            messageDiv.innerHTML = `
                <div class="message-header">
                    <span class="sender-name">${senderName}</span>
                    <span class="message-time">${timestamp}</span>
                </div>
                <div class="message-content">${escapeHtml(message.content)}</div>
            `;
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Send message
        async function sendMessage() {
            const content = messageInput.value.trim();
            if (!content || !conversationActive || !conversationId) return;
            
            // Disable input while processing
            messageInput.disabled = true;
            sendButton.disabled = true;
            
            // Add user message to chat
            const userMessage = {
                role: 'user',
                content: content,
                timestamp: new Date().toISOString()
            };
            addMessage(userMessage);
            
            // Clear input
            messageInput.value = '';
            
            try {
                // Send to API
                const response = await fetch(`/api/conversations/${conversationId}/message`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ content })
                });
                
                if (response.status === 410) {
                    // Time limit exceeded
                    endConversation('time_limit');
                    return;
                }
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                // Add assistant reply
                const assistantMessage = {
                    role: 'assistant',
                    content: data.reply,
                    timestamp: new Date().toISOString()
                };
                addMessage(assistantMessage);
                
            } catch (error) {
                console.error('Error sending message:', error);
                alert('Error sending message. Please try again.');
                
                // Re-add the message to input for retry
                messageInput.value = content;
            } finally {
                // Re-enable input if conversation is still active
                if (conversationActive) {
                    messageInput.disabled = false;
                    updateSendButtonState();
                    messageInput.focus();
                }
            }
        }
        
        function updateSendButtonState() {
            const hasContent = messageInput.value.trim().length > 0;
            sendButton.disabled = !hasContent || !conversationActive;
        }
        
        // End conversation
        async function endConversation(reason) {
            if (!conversationActive) return;
            
            conversationActive = false;
            stopTimer();
            
            messageInput.disabled = true;
            sendButton.disabled = true;
            
            // Call end conversation API
            if (conversationId) {
                try {
                    await fetch(`/api/conversations/${conversationId}/end`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                } catch (error) {
                    console.error('Error ending conversation:', error);
                }
            }
            
            let reasonText;
            switch(reason) {
                case 'time_limit':
                    reasonText = 'Your 10-minute conversation has ended.';
                    break;
                default:
                    reasonText = 'The conversation has ended.';
            }
            
            document.getElementById('endReason').textContent = reasonText;
            endModal.style.display = 'flex';
        }
        
        // Event listeners
        messageInput.addEventListener('input', updateSendButtonState);
        
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                if (!sendButton.disabled) {
                    sendMessage();
                }
            }
        });
        
        sendButton.addEventListener('click', () => {
            if (!sendButton.disabled) {
                sendMessage();
            }
        });
        
        document.getElementById('continueBtn').addEventListener('click', () => {
            window.location.href = '/exit-survey';
        });
        
        // Handle page unload
        window.addEventListener('beforeunload', () => {
            if (conversationActive && conversationId) {
                // Send end conversation request (may not complete due to page unload)
                navigator.sendBeacon(`/api/conversations/${conversationId}/end`, 
                    JSON.stringify({}));
            }
        });
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', () => {
            initializeConversation();
        });
    </script>
</body>
</html>