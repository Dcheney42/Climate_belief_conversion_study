<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Climate Change Conversation</title>
    <link rel="stylesheet" href="/messenger-styles.css">
</head>
<body>
    <div class="chat-container">
        <div class="chat-header">
            <div class="chat-title">
                <h1>Climate Change Conversation</h1>
                <p>You are now in conversation with an AI assistant</p>
            </div>
            
            <div class="timer-display">
                <div class="timer-circle">
                    <span id="timeRemaining">10:00</span>
                </div>
                <p>Time Remaining</p>
            </div>
        </div>
        
        <div class="chat-main">
            <div class="chat-messages" id="chatMessages">
                <div class="system-message">
                    <div class="message-content">Conversation started. You have 10 minutes to chat.</div>
                </div>
            </div>
            
            <div class="chat-input-area">
                <div class="input-helper" id="inputHelper" style="display: none;">
                    <small>Type "end the chat" to finish early.</small>
                </div>
                <div class="input-container">
                    <textarea id="messageInput" placeholder="Type your message here..." rows="1" disabled></textarea>
                    <div class="input-controls">
                        <button id="sendButton" class="btn-primary" disabled>Send</button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="chat-status">
            <span id="connectionStatus" class="status-connected">Connected</span>
        </div>
    </div>
    
    <!-- Conversation End Modal -->
    <div id="endModal" class="modal" style="display: none;">
        <div class="modal-content">
            <h2>Conversation Ended</h2>
            <p id="endReason">Your 10-minute conversation has ended.</p>
            <p>Thank you for participating! You will now be redirected to a brief exit survey.</p>
            <button id="continueBtn" class="btn-primary">Continue to Exit Survey</button>
        </div>
    </div>

    <script>
        let conversationId = null;
        let participantId = null;
        let conversationActive = false;
        let timeRemaining = 600; // 10 minutes in seconds
        let warningShown = false; // Track if 1-minute warning has been shown
        let timerInterval = null;
        
        // DOM elements
        const chatMessages = document.getElementById('chatMessages');
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        const timeDisplay = document.getElementById('timeRemaining');
        const endModal = document.getElementById('endModal');
        const connectionStatus = document.getElementById('connectionStatus');
        
        // Get participant ID from URL or session storage
        function getParticipantId() {
            // Try to get from URL path first (e.g., /chat/participant-id)
            const pathParts = window.location.pathname.split('/');
            if (pathParts.length >= 3 && pathParts[1] === 'chat') {
                return pathParts[2];
            }
            
            // Fallback to session storage
            return sessionStorage.getItem('participant_id');
        }
        
        // Check if in testing mode
        function isTestingMode() {
            return window.location.search.includes('testing=true') ||
                   localStorage.getItem('testing_mode') === 'true';
        }
        
        // Initialize conversation
        async function initializeConversation() {
            participantId = getParticipantId();
            
            // Show testing helper if in testing mode
            if (isTestingMode()) {
                document.getElementById('inputHelper').style.display = 'block';
            }
            
            if (!participantId) {
                alert('Invalid session. Please start the study again.');
                window.location.href = '/';
                return;
            }
            
            try {
                // Start conversation with the enhanced API
                const response = await fetch('/chat/start', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ userId: participantId })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                conversationId = data.conversationId;
                conversationActive = true;
                
                // Enable input and start timer
                messageInput.disabled = false;
                messageInput.placeholder = "Type your message here...";
                updateSendButtonState();
                startTimer();
                
                // Add dynamic opening assistant message from enhanced system
                if (data.messages && data.messages.length > 1) {
                    const openingMessage = data.messages.find(msg => msg.role === 'assistant');
                    if (openingMessage) {
                        addMessage({
                            role: 'assistant',
                            content: openingMessage.content,
                            timestamp: new Date().toISOString()
                        });
                    }
                }
                
                connectionStatus.textContent = 'Connected';
                connectionStatus.className = 'status-connected';
                
            } catch (error) {
                console.error('Error starting conversation:', error);
                connectionStatus.textContent = 'Connection Error';
                connectionStatus.className = 'status-disconnected';
                alert('Error starting conversation. Please try again.');
            }
        }
        
        // Timer functions
        function updateTimer() {
            if (timeRemaining <= 0) {
                endConversation('time_limit');
                return;
            }
            
            // Show 1-minute warning at exactly 60 seconds remaining
            if (timeRemaining === 60 && !warningShown && conversationActive) {
                showOneMinuteWarning();
                warningShown = true;
            }
            
            const minutes = Math.floor(timeRemaining / 60);
            const seconds = timeRemaining % 60;
            timeDisplay.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            
            // Warning colors (adjusted for 10 minutes)
            if (timeRemaining <= 60) {
                timeDisplay.style.color = '#ff4444';
            } else if (timeRemaining <= 180) {
                timeDisplay.style.color = '#ff8800';
            }
            
            timeRemaining--;
        }
        
        function startTimer() {
            timerInterval = setInterval(updateTimer, 1000);
        }
        
        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
        }
        
        // Message functions
        function addMessage(message) {
            const messageDiv = document.createElement('div');
            const isUser = message.role === 'user';
            const isSystem = message.role === 'system';
            messageDiv.className = `message ${isUser ? 'own-message' : 'other-message'}`;
            
            const timestamp = new Date(message.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            const senderName = isUser ? 'You' : (isSystem ? 'System' : 'Assistant');
            
            messageDiv.innerHTML = `
                <div class="message-header">
                    <span class="sender-name">${senderName}</span>
                    <span class="message-time">${timestamp}</span>
                </div>
                <div class="message-content">${escapeHtml(message.content)}</div>
            `;
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        // Generate conversation summary for 1-minute warning and final validation
        function generateConversationSummary() {
            const messages = Array.from(chatMessages.querySelectorAll('.message'));
            const userMessages = messages.filter(msg => msg.querySelector('.sender-name').textContent === 'You');
            const assistantMessages = messages.filter(msg => msg.querySelector('.sender-name').textContent === 'Assistant');
            
            let summary = '';
            const topics = [];
            
            // Extract key themes from user messages
            userMessages.forEach(msg => {
                const content = msg.querySelector('.message-content').textContent;
                if (content.length > 20) { // Only meaningful messages
                    // Simple keyword extraction
                    if (content.toLowerCase().includes('change') || content.toLowerCase().includes('shift')) {
                        topics.push('Discussed belief change process');
                    }
                    if (content.toLowerCase().includes('evidence') || content.toLowerCase().includes('research') || content.toLowerCase().includes('study')) {
                        topics.push('Mentioned evidence or research');
                    }
                    if (content.toLowerCase().includes('people') || content.toLowerCase().includes('family') || content.toLowerCase().includes('friend')) {
                        topics.push('Talked about social influences');
                    }
                    if (content.toLowerCase().includes('media') || content.toLowerCase().includes('news') || content.toLowerCase().includes('article')) {
                        topics.push('Discussed media influences');
                    }
                    if (content.toLowerCase().includes('experience') || content.toLowerCase().includes('personal') || content.toLowerCase().includes('saw') || content.toLowerCase().includes('noticed')) {
                        topics.push('Shared personal experiences');
                    }
                }
            });
            
            // Remove duplicates and limit to 4-5 key points
            const uniqueTopics = [...new Set(topics)].slice(0, 5);
            
            if (uniqueTopics.length === 0) {
                summary = 'â€¢ Shared initial thoughts about climate change belief change';
            } else {
                summary = uniqueTopics.map(topic => `â€¢ ${topic}`).join('\n\n');
            }
            
            return summary;
        }
        
        // Generate conversation summary as array for validation page
        function generateConversationSummaryArray() {
            console.log('ðŸ” Starting comprehensive summary extraction process...');
            
            const messages = Array.from(chatMessages.querySelectorAll('.message'));
            const assistantMessages = messages.filter(msg => msg.querySelector('.sender-name').textContent === 'Assistant');
            
            console.log(`ðŸ“Š Found ${assistantMessages.length} assistant messages to analyze`);
            
            // PHASE 1: Look for explicit summaries with keywords
            console.log('ðŸ”Ž Phase 1: Searching for explicit summary keywords...');
            for (let i = assistantMessages.length - 1; i >= Math.max(0, assistantMessages.length - 5); i--) {
                const msg = assistantMessages[i];
                const content = msg.querySelector('.message-content').textContent;
                
                // Enhanced keyword detection
                const summaryKeywords = [
                    'summarize', 'summary', 'key themes', 'main points', 'to summarize',
                    'based on our conversation', 'key takeaways', 'important points',
                    'what we\'ve discussed', 'recap', 'review what', 'covered today',
                    'themes that emerged', 'highlights from', 'essence of'
                ];
                
                const hasKeyword = summaryKeywords.some(keyword =>
                    content.toLowerCase().includes(keyword.toLowerCase())
                );
                
                if (hasKeyword) {
                    const extractedSummary = extractBulletPointsFromSummary(content);
                    if (extractedSummary.length > 0) {
                        console.log('âœ… Found explicit summary with keywords:', extractedSummary);
                        return extractedSummary;
                    }
                }
            }
            
            // PHASE 2: Look for structured lists (bullet points, numbered lists)
            console.log('ðŸ”Ž Phase 2: Searching for structured bullet point lists...');
            for (let i = assistantMessages.length - 1; i >= Math.max(0, assistantMessages.length - 5); i--) {
                const msg = assistantMessages[i];
                const content = msg.querySelector('.message-content').textContent;
                
                // Enhanced bullet point detection
                const bulletPatterns = [
                    /[â€¢\*\-]\s+.+/g,    // Bullet points
                    /\d+\.\s+.+/g,      // Numbered lists
                    /[a-zA-Z]\.\s+.+/g, // Lettered lists
                    /\n\s*[-â€¢*]\s+/g,   // Line-broken bullets
                ];
                
                let hasStructure = false;
                for (const pattern of bulletPatterns) {
                    const matches = content.match(pattern);
                    if (matches && matches.length >= 2) {
                        hasStructure = true;
                        break;
                    }
                }
                
                if (hasStructure) {
                    const extractedSummary = extractBulletPointsFromSummary(content);
                    if (extractedSummary.length >= 2) {
                        console.log('âœ… Found structured list:', extractedSummary);
                        return extractedSummary;
                    }
                }
            }
            
            // PHASE 3: Look for long, comprehensive messages
            console.log('ðŸ”Ž Phase 3: Searching for comprehensive messages...');
            for (let i = assistantMessages.length - 1; i >= Math.max(0, assistantMessages.length - 3); i--) {
                const msg = assistantMessages[i];
                const content = msg.querySelector('.message-content').textContent;
                
                // Look for longer, more comprehensive messages that might contain implicit summaries
                if (content.length > 200) {
                    const implicitSummary = extractImplicitSummaryPoints(content);
                    if (implicitSummary.length >= 2) {
                        console.log('âœ… Found implicit summary in long message:', implicitSummary);
                        return implicitSummary;
                    }
                }
            }
            
            // PHASE 4: Look for any message with multiple thematic elements
            console.log('ðŸ”Ž Phase 4: Searching for thematic content across all messages...');
            const thematicSummary = extractThematicSummary(assistantMessages);
            if (thematicSummary.length >= 2) {
                console.log('âœ… Found thematic summary:', thematicSummary);
                return thematicSummary;
            }
            
            // PHASE 5: Ultimate fallback generation
            console.log('âš ï¸ No structured summary found, generating comprehensive fallback...');
            const fallbackSummary = generateFallbackSummaryArray();
            console.log('ðŸ“ Generated fallback summary:', fallbackSummary);
            return fallbackSummary;
        }
        
        // Extract bullet points from a chatbot summary message
        function extractBulletPointsFromSummary(summaryText) {
            const bulletPoints = [];
            
            // First, clean the entire summary text to remove follow-up questions
            let cleanedSummary = cleanChatbotSummaryText(summaryText);
            
            // Split by common bullet point indicators
            const lines = cleanedSummary.split(/[â€¢\*\-]/).filter(line => line.trim().length > 0);
            
            for (let i = 1; i < lines.length; i++) { // Skip the first split (before first bullet)
                let point = lines[i].trim();
                
                // Clean up the bullet point
                point = point.replace(/^[â€¢\*\-\s]+/, ''); // Remove leading bullets/spaces
                point = point.replace(/[.!?]*$/, ''); // Remove trailing punctuation
                point = point.trim();
                
                // Only include substantial points
                if (point.length > 10 && !point.toLowerCase().includes('thank you') &&
                    !point.toLowerCase().includes('based on our conversation')) {
                    // Ensure it starts with capital letter and ends with period
                    if (point.length > 0) {
                        point = point.charAt(0).toUpperCase() + point.slice(1);
                        if (!point.endsWith('.')) {
                            point += '.';
                        }
                        bulletPoints.push(point);
                    }
                }
            }
            
            return bulletPoints;
        }
        
        // Extract implicit summary points from longer messages
        function extractImplicitSummaryPoints(content) {
            const points = [];
            
            // Split content into sentences
            const sentences = content.split(/[.!?]+/).filter(s => s.trim().length > 20);
            
            // Look for sentences that sound like summary statements
            const summaryIndicators = [
                /you (?:mentioned|talked about|shared|discussed|described)/i,
                /it sounds like you/i,
                /from what (?:you've said|you described)/i,
                /your (?:experience|perspective|view|story)/i,
                /the (?:key|main|important) (?:point|factor|element|thing)/i,
                /this (?:seems|appears) to be/i,
                /what's (?:interesting|important|significant)/i
            ];
            
            for (const sentence of sentences) {
                const hasIndicator = summaryIndicators.some(pattern => pattern.test(sentence));
                if (hasIndicator && sentence.trim().length > 30) {
                    let cleanedSentence = sentence.trim();
                    // Capitalize first letter and add period
                    cleanedSentence = cleanedSentence.charAt(0).toUpperCase() + cleanedSentence.slice(1);
                    if (!cleanedSentence.endsWith('.')) {
                        cleanedSentence += '.';
                    }
                    points.push(cleanedSentence);
                }
            }
            
            return points.slice(0, 4); // Limit to 4 points
        }
        
        // Extract thematic content across multiple assistant messages
        function extractThematicSummary(assistantMessages) {
            const themes = {
                evidence: [],
                personal: [],
                social: [],
                change_process: [],
                media: [],
                general: []
            };
            
            assistantMessages.forEach(msg => {
                const content = msg.querySelector('.message-content').textContent.toLowerCase();
                
                // Extract sentences that mention key themes
                const sentences = content.split(/[.!?]+/);
                
                sentences.forEach(sentence => {
                    if (sentence.length < 20) return;
                    
                    const cleanSentence = sentence.trim();
                    if (cleanSentence.includes('evidence') || cleanSentence.includes('research') || cleanSentence.includes('data')) {
                        themes.evidence.push('You discussed evidence and research related to climate change');
                    }
                    
                    if (cleanSentence.includes('personal') || cleanSentence.includes('experience') || cleanSentence.includes('yourself')) {
                        themes.personal.push('You shared personal experiences and observations');
                    }
                    
                    if (cleanSentence.includes('people') || cleanSentence.includes('others') || cleanSentence.includes('family') || cleanSentence.includes('friends')) {
                        themes.social.push('You talked about social influences and other people');
                    }
                    
                    if (cleanSentence.includes('change') || cleanSentence.includes('shift') || cleanSentence.includes('evolve')) {
                        themes.change_process.push('You described how your views changed over time');
                    }
                    
                    if (cleanSentence.includes('media') || cleanSentence.includes('news') || cleanSentence.includes('article')) {
                        themes.media.push('You mentioned media sources and information');
                    }
                });
            });
            
            // Convert themes to unique summary points
            const summaryPoints = [];
            Object.keys(themes).forEach(themeKey => {
                if (themes[themeKey].length > 0) {
                    // Use the first occurrence of each theme
                    summaryPoints.push(themes[themeKey][0]);
                }
            });
            
            // Remove duplicates and return
            return [...new Set(summaryPoints)].slice(0, 5);
        }

        // Clean chatbot summary text to remove follow-up questions and validation prompts
        function cleanChatbotSummaryText(text) {
            let cleanedText = text;
            
            // Remove various trailing question patterns that the chatbot adds
            const questionPatterns = [
                // Specific patterns for validation questions
                /\s*Does this (?:summary )?(?:capture|reflect) your experience accurately.*$/i,
                /\s*Does this (?:summary )?(?:capture|reflect) your (?:experience|views|thoughts) (?:accurately|correctly).*$/i,
                /\s*Does (?:this|that) sound about right.*$/i,
                /\s*Do(?:es)? th(?:is|at|ese) (?:points? )?(?:capture|sound|seem|reflect).*$/i,
                /\s*Is (?:this|that) (?:summary )?(?:accurate|correct|right).*$/i,
                /\s*Does (?:this|that) (?:accurately )?(?:capture|summarize|reflect).*$/i,
                
                // General validation and follow-up patterns
                /\s*Would you like (?:to add|me to|to).*$/i,
                /\s*Feel free to (?:add|adjust|correct|let me know).*$/i,
                /\s*Let me know if (?:you|I|this|there).*$/i,
                /\s*(?:Any|Anything) (?:else|to add|missing|you'd like).*$/i,
                /\s*(?:Is there|Are there) (?:anything|any).*$/i,
                /\s*Or (?:is there|would you).*$/i,
                
                // Chatbot invitation patterns
                /\s*What (?:do you think|would you).*$/i,
                /\s*How (?:does (?:this|that)|would you).*$/i,
                /\s*Should (?:I|we).*$/i,
                /\s*Can (?:I|you|we).*$/i,
                
                // Common trailing fragments
                /\s*[,;]\s*or\.?$/i,
                /\s*[,;]\s*and\.?$/i,
                /\s*[,;]\s*but\.?$/i,
                /\s*\?\s*$/,  // Remove trailing question marks
                /\s*[,;]\s*$/  // Remove trailing commas/semicolons
            ];
            
            // Apply each pattern to remove trailing questions
            questionPatterns.forEach(pattern => {
                cleanedText = cleanedText.replace(pattern, '');
            });
            
            // Remove any remaining trailing punctuation artifacts
            cleanedText = cleanedText.replace(/[,;]\s*$/g, '');
            
            return cleanedText.trim();
        }
        
        // Fallback summary generation when no real summary is found
        function generateFallbackSummaryArray() {
            const messages = Array.from(chatMessages.querySelectorAll('.message'));
            const userMessages = messages.filter(msg => msg.querySelector('.sender-name').textContent === 'You');
            
            const topics = [];
            
            // Extract key themes from user messages
            userMessages.forEach(msg => {
                const content = msg.querySelector('.message-content').textContent;
                if (content.length > 20) { // Only meaningful messages
                    // Simple keyword extraction
                    if (content.toLowerCase().includes('change') || content.toLowerCase().includes('shift')) {
                        topics.push('Discussed belief change process');
                    }
                    if (content.toLowerCase().includes('evidence') || content.toLowerCase().includes('research') || content.toLowerCase().includes('study')) {
                        topics.push('Mentioned evidence or research');
                    }
                    if (content.toLowerCase().includes('people') || content.toLowerCase().includes('family') || content.toLowerCase().includes('friend')) {
                        topics.push('Talked about social influences');
                    }
                    if (content.toLowerCase().includes('media') || content.toLowerCase().includes('news') || content.toLowerCase().includes('article')) {
                        topics.push('Discussed media influences');
                    }
                    if (content.toLowerCase().includes('experience') || content.toLowerCase().includes('personal') || content.toLowerCase().includes('saw') || content.toLowerCase().includes('noticed')) {
                        topics.push('Shared personal experiences');
                    }
                }
            });
            
            // Remove duplicates and limit to 4-5 key points
            const uniqueTopics = [...new Set(topics)].slice(0, 5);
            
            if (uniqueTopics.length === 0) {
                return ['Shared initial thoughts about climate change belief change'];
            } else {
                return uniqueTopics;
            }
        }
        
        // Save chatbot summary to sessionStorage before redirect with comprehensive logging
        function saveChatbotSummary() {
            console.log('ðŸ”„ Starting chatbot summary save process...');
            
            try {
                // Track extraction attempt
                const extractionStart = performance.now();
                const summaryArray = generateConversationSummaryArray();
                const extractionTime = performance.now() - extractionStart;
                
                console.log(`â±ï¸ Summary extraction completed in ${extractionTime.toFixed(2)}ms`);
                console.log(`ðŸ“ Extracted ${summaryArray.length} summary points:`, summaryArray);
                
                // Validate summary quality
                if (!summaryArray || summaryArray.length === 0) {
                    console.warn('âš ï¸ Empty summary array, generating emergency fallback');
                    const emergencyFallback = generateEmergencyFallback();
                    sessionStorage.setItem('chatbot_summary', JSON.stringify(emergencyFallback));
                    console.log('ðŸš¨ Emergency fallback summary saved:', emergencyFallback);
                    return;
                }
                
                // Check for placeholder/generic content
                const hasGenericContent = summaryArray.every(point =>
                    point.includes('participated') ||
                    point.includes('engaged') ||
                    point.includes('shared perspective')
                );
                
                if (hasGenericContent && summaryArray.length < 3) {
                    console.warn('âš ï¸ Generic summary content detected, enhancing...');
                    const enhancedSummary = enhanceGenericSummary(summaryArray);
                    sessionStorage.setItem('chatbot_summary', JSON.stringify(enhancedSummary));
                    console.log('âœ¨ Enhanced generic summary saved:', enhancedSummary);
                    return;
                }
                
                // Save successful summary
                sessionStorage.setItem('chatbot_summary', JSON.stringify(summaryArray));
                console.log('âœ… Chatbot summary successfully saved to sessionStorage');
                console.log('ðŸ“Š Summary statistics:', {
                    pointCount: summaryArray.length,
                    averageLength: Math.round(summaryArray.reduce((sum, point) => sum + point.length, 0) / summaryArray.length),
                    totalCharacters: summaryArray.join('').length
                });
                
            } catch (error) {
                console.error('âŒ Critical error in summary save process:', error);
                console.error('Stack trace:', error.stack);
                
                // Multi-level fallback system
                try {
                    console.log('ðŸ”„ Attempting basic conversation analysis fallback...');
                    const basicSummary = generateBasicConversationSummary();
                    sessionStorage.setItem('chatbot_summary', JSON.stringify(basicSummary));
                    console.log('âš¡ Basic summary saved as fallback:', basicSummary);
                } catch (fallbackError) {
                    console.error('âŒ Fallback summary generation failed:', fallbackError);
                    console.log('ðŸš¨ Using ultimate emergency fallback');
                    
                    // Ultimate emergency fallback
                    const ultimateFallback = ['You participated in a research conversation about climate change beliefs'];
                    sessionStorage.setItem('chatbot_summary', JSON.stringify(ultimateFallback));
                    console.log('ðŸ›¡ï¸ Ultimate fallback summary saved');
                }
            }
        }
        
        // Generate emergency fallback when all else fails
        function generateEmergencyFallback() {
            const messages = Array.from(chatMessages.querySelectorAll('.message'));
            const userMessages = messages.filter(msg =>
                msg.querySelector('.sender-name')?.textContent === 'You'
            );
            
            if (userMessages.length > 0) {
                return [
                    'You shared your thoughts about climate change in our conversation',
                    'You discussed your personal perspective on this important topic'
                ];
            } else {
                return [
                    'You participated in a research conversation about climate change'
                ];
            }
        }
        
        // Enhance generic summary with more specific details
        function enhanceGenericSummary(originalSummary) {
            const enhanced = [...originalSummary];
            
            // Add conversation context
            const messages = Array.from(chatMessages.querySelectorAll('.message'));
            if (messages.length > 5) {
                enhanced.push('You engaged in an extended dialogue about your views');
            }
            
            // Check for question-answer patterns
            const questionCount = messages.filter(msg =>
                msg.querySelector('.message-content')?.textContent.includes('?')
            ).length;
            
            if (questionCount > 2) {
                enhanced.push('You responded to questions about your belief change experience');
            }
            
            // Ensure minimum length
            while (enhanced.length < 3) {
                enhanced.push('You contributed meaningfully to the research conversation');
            }
            
            return enhanced.slice(0, 5);
        }
        
        // Basic conversation analysis for when detailed extraction fails
        function generateBasicConversationSummary() {
            const messages = Array.from(chatMessages.querySelectorAll('.message'));
            const userMessages = messages.filter(msg =>
                msg.querySelector('.sender-name')?.textContent === 'You'
            );
            const assistantMessages = messages.filter(msg =>
                msg.querySelector('.sender-name')?.textContent === 'Assistant'
            );
            
            const summary = [];
            
            // Basic participation
            summary.push('You participated in a conversation about climate change beliefs');
            
            // Message count analysis
            if (userMessages.length > 3) {
                summary.push('You shared multiple perspectives during the discussion');
            }
            
            // Interaction analysis
            if (assistantMessages.length > 3) {
                summary.push('You engaged in back-and-forth dialogue about the topic');
            }
            
            // Length analysis
            const hasLongMessages = userMessages.some(msg =>
                msg.querySelector('.message-content')?.textContent.length > 100
            );
            
            if (hasLongMessages) {
                summary.push('You provided detailed responses about your experiences');
            }
            
            return summary.slice(0, 4);
        }
        
        // Show 1-minute warning with summary
        async function showOneMinuteWarning() {
            const summary = generateConversationSummary();
            const warningMessage = `We're almost out of time â€” about one minute left.

${summary}

Is there anything important you'd like to add before we finish?`;
            
            // Add system message
            addMessage({
                role: 'system',
                content: warningMessage,
                timestamp: new Date().toISOString()
            });
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Send message
        async function sendMessage() {
            const content = messageInput.value.trim();
            if (!content || !conversationActive || !conversationId) return;
            
            // Disable input while processing
            messageInput.disabled = true;
            sendButton.disabled = true;
            
            // Add user message to chat
            const userMessage = {
                role: 'user',
                content: content,
                timestamp: new Date().toISOString()
            };
            addMessage(userMessage);
            
            // Clear input
            messageInput.value = '';
            
            try {
                // Send to enhanced API
                const response = await fetch('/chat/reply', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ conversationId, message: content })
                });
                
                if (response.status === 410) {
                    // Time limit exceeded - show brief message and redirect
                    // Add a final assistant-style message to the chat window
                    const messagesDiv = document.getElementById('chatMessages');
                    const endMsg = document.createElement('div');
                    endMsg.className = 'message other-message';
                    endMsg.innerHTML = `
                        <div class="message-header">
                            <span class="sender-name">Assistant</span>
                            <span class="message-time">${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>
                        </div>
                        <div class="message-content">The chat has now ended. Please continue to the final survey.</div>
                    `;
                    messagesDiv.appendChild(endMsg);

                    // Scroll to bottom
                    messagesDiv.scrollTop = messagesDiv.scrollHeight;

                    // Save chatbot summary before redirect
                    saveChatbotSummary();

                    // Redirect after short delay
                    setTimeout(() => {
                        window.location.href = '/exit-survey';
                    }, 2000);
                    return;
                }
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                // Check if session ended
                if (data.sessionEnded) {
                    // Add assistant reply
                    const assistantMessage = {
                        role: 'assistant',
                        content: data.reply,
                        timestamp: new Date().toISOString()
                    };
                    addMessage(assistantMessage);
                    
                    // Show brief message and redirect
                    // Add a final assistant-style message to the chat window
                    const messagesDiv = document.getElementById('chatMessages');
                    const endMsg = document.createElement('div');
                    endMsg.className = 'message other-message';
                    endMsg.innerHTML = `
                        <div class="message-header">
                            <span class="sender-name">Assistant</span>
                            <span class="message-time">${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>
                        </div>
                        <div class="message-content">The chat has now ended. Please continue to the final survey.</div>
                    `;
                    messagesDiv.appendChild(endMsg);

                    // Scroll to bottom
                    messagesDiv.scrollTop = messagesDiv.scrollHeight;

                    // Save chatbot summary before redirect
                    saveChatbotSummary();

                    // Redirect after short delay
                    setTimeout(() => {
                        window.location.href = '/exit-survey';
                    }, 2000);
                    return;
                }
                
                // Add assistant reply
                const assistantMessage = {
                    role: 'assistant',
                    content: data.reply,
                    timestamp: new Date().toISOString()
                };
                addMessage(assistantMessage);
                
            } catch (error) {
                console.error('Error sending message:', error);
                alert('Error sending message. Please try again.');
                
                // Re-add the message to input for retry
                messageInput.value = content;
            } finally {
                // Re-enable input if conversation is still active
                if (conversationActive) {
                    messageInput.disabled = false;
                    updateSendButtonState();
                    messageInput.focus();
                }
            }
        }
        
        function updateSendButtonState() {
            const hasContent = messageInput.value.trim().length > 0;
            sendButton.disabled = !hasContent || !conversationActive;
        }
        
        // End conversation
        async function endConversation(reason) {
            if (!conversationActive) return;
            
            conversationActive = false;
            stopTimer();
            
            messageInput.disabled = true;
            sendButton.disabled = true;
            
            // End conversation (enhanced system handles this automatically)
            // No separate end endpoint needed with new chat system
            
            let reasonText;
            switch(reason) {
                case 'time_limit':
                    reasonText = 'Your 10-minute conversation has ended.';
                    break;
                case 'user_ended':
                    reasonText = 'You ended the conversation early.';
                    break;
                default:
                    reasonText = 'The conversation has ended.';
            }
            
            // Save chatbot summary when conversation ends
            saveChatbotSummary();
            
            document.getElementById('endReason').textContent = reasonText;
            endModal.style.display = 'flex';
        }
        
        // Event listeners
        messageInput.addEventListener('input', updateSendButtonState);
        
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                if (!sendButton.disabled) {
                    sendMessage();
                }
            }
        });
        
        sendButton.addEventListener('click', () => {
            if (!sendButton.disabled) {
                sendMessage();
            }
        });
        
        document.getElementById('continueBtn').addEventListener('click', () => {
            // Summary is already saved when endConversation() was called
            window.location.href = '/exit-survey';
        });
        
        // Handle page unload
        window.addEventListener('beforeunload', () => {
            if (conversationActive && conversationId) {
                // Send end conversation request (may not complete due to page unload)
                navigator.sendBeacon(`/api/conversations/${conversationId}/end`, 
                    JSON.stringify({}));
            }
        });
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', () => {
            initializeConversation();
        });
    </script>
</body>
</html>