<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Climate Change Conversation</title>
    <link rel="stylesheet" href="/messenger-styles.css">
</head>
<body>
    <div class="chat-container">
        <div class="chat-header">
            <div class="chat-title">
                <h1>Climate Change Conversation</h1>
                <p>You are now in conversation with an AI assistant</p>
            </div>
            
            <div class="timer-display">
                <div class="timer-circle">
                    <span id="timeRemaining">10:00</span>
                </div>
                <p>Time Remaining</p>
            </div>
        </div>
        
        <div class="chat-main">
            <div class="chat-messages" id="chatMessages">
                <div class="system-message">
                    <div class="message-content">Conversation started. You have 10 minutes to chat.</div>
                </div>
            </div>
            
            <div class="chat-input-area">
                <div class="input-helper" id="inputHelper" style="display: none;">
                    <small>Type "end the chat" to finish early.</small>
                </div>
                <div class="input-container">
                    <textarea id="messageInput" placeholder="Type your message here..." rows="1" disabled></textarea>
                    <div class="input-controls">
                        <button id="sendButton" class="btn-primary" disabled>Send</button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="chat-status">
            <span id="connectionStatus" class="status-connected">Connected</span>
        </div>
    </div>
    
    <!-- Conversation End Modal -->
    <div id="endModal" class="modal" style="display: none;">
        <div class="modal-content">
            <h2>Conversation Ended</h2>
            <p id="endReason">Your 10-minute conversation has ended.</p>
            <p>Thank you for participating! You will now be redirected to a brief exit survey.</p>
            <button id="continueBtn" class="btn-primary">Continue to Exit Survey</button>
        </div>
    </div>

    <script>
        let conversationId = null;
        let participantId = null;
        let conversationActive = false;
        let timeRemaining = 600; // 10 minutes in seconds
        let warningShown = false; // Track if 1-minute warning has been shown
        let timerInterval = null;
        
        // DOM elements
        const chatMessages = document.getElementById('chatMessages');
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        const timeDisplay = document.getElementById('timeRemaining');
        const endModal = document.getElementById('endModal');
        const connectionStatus = document.getElementById('connectionStatus');
        
        // Get participant ID from URL or session storage
        function getParticipantId() {
            // Try to get from URL path first (e.g., /chat/participant-id)
            const pathParts = window.location.pathname.split('/');
            if (pathParts.length >= 3 && pathParts[1] === 'chat') {
                return pathParts[2];
            }
            
            // Fallback to session storage
            return sessionStorage.getItem('participant_id');
        }
        
        // Check if in testing mode
        function isTestingMode() {
            return window.location.search.includes('testing=true') ||
                   localStorage.getItem('testing_mode') === 'true';
        }
        
        // Initialize conversation
        async function initializeConversation() {
            participantId = getParticipantId();
            
            // Show testing helper if in testing mode
            if (isTestingMode()) {
                document.getElementById('inputHelper').style.display = 'block';
            }
            
            if (!participantId) {
                alert('Invalid session. Please start the study again.');
                window.location.href = '/';
                return;
            }
            
            try {
                // Start conversation with the enhanced API
                const response = await fetch('/chat/start', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ userId: participantId })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                conversationId = data.conversationId;
                conversationActive = true;
                
                // Enable input and start timer
                messageInput.disabled = false;
                messageInput.placeholder = "Type your message here...";
                updateSendButtonState();
                startTimer();
                
                // Add dynamic opening assistant message from enhanced system
                if (data.messages && data.messages.length > 1) {
                    const openingMessage = data.messages.find(msg => msg.role === 'assistant');
                    if (openingMessage) {
                        addMessage({
                            role: 'assistant',
                            content: openingMessage.content,
                            timestamp: new Date().toISOString()
                        });
                    }
                }
                
                connectionStatus.textContent = 'Connected';
                connectionStatus.className = 'status-connected';
                
            } catch (error) {
                console.error('Error starting conversation:', error);
                connectionStatus.textContent = 'Connection Error';
                connectionStatus.className = 'status-disconnected';
                alert('Error starting conversation. Please try again.');
            }
        }
        
        // Timer functions
        function updateTimer() {
            if (timeRemaining <= 0) {
                endConversation('time_limit');
                return;
            }
            
            // Show 1-minute warning at exactly 60 seconds remaining
            if (timeRemaining === 60 && !warningShown && conversationActive) {
                showOneMinuteWarning();
                warningShown = true;
            }
            
            const minutes = Math.floor(timeRemaining / 60);
            const seconds = timeRemaining % 60;
            timeDisplay.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            
            // Warning colors (adjusted for 10 minutes)
            if (timeRemaining <= 60) {
                timeDisplay.style.color = '#ff4444';
            } else if (timeRemaining <= 180) {
                timeDisplay.style.color = '#ff8800';
            }
            
            timeRemaining--;
        }
        
        function startTimer() {
            timerInterval = setInterval(updateTimer, 1000);
        }
        
        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
        }
        
        // Message functions
        function addMessage(message) {
            const messageDiv = document.createElement('div');
            const isUser = message.role === 'user';
            const isSystem = message.role === 'system';
            messageDiv.className = `message ${isUser ? 'own-message' : 'other-message'}`;
            
            const timestamp = new Date(message.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            const senderName = isUser ? 'You' : (isSystem ? 'System' : 'Assistant');
            
            messageDiv.innerHTML = `
                <div class="message-header">
                    <span class="sender-name">${senderName}</span>
                    <span class="message-time">${timestamp}</span>
                </div>
                <div class="message-content">${escapeHtml(message.content)}</div>
            `;
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        // Generate conversation summary for 1-minute warning and final validation
        function generateConversationSummary() {
            const messages = Array.from(chatMessages.querySelectorAll('.message'));
            const userMessages = messages.filter(msg => msg.querySelector('.sender-name').textContent === 'You');
            const assistantMessages = messages.filter(msg => msg.querySelector('.sender-name').textContent === 'Assistant');
            
            let summary = '';
            const topics = [];
            
            // Extract key themes from user messages
            userMessages.forEach(msg => {
                const content = msg.querySelector('.message-content').textContent;
                if (content.length > 20) { // Only meaningful messages
                    // Simple keyword extraction
                    if (content.toLowerCase().includes('change') || content.toLowerCase().includes('shift')) {
                        topics.push('Discussed belief change process');
                    }
                    if (content.toLowerCase().includes('evidence') || content.toLowerCase().includes('research') || content.toLowerCase().includes('study')) {
                        topics.push('Mentioned evidence or research');
                    }
                    if (content.toLowerCase().includes('people') || content.toLowerCase().includes('family') || content.toLowerCase().includes('friend')) {
                        topics.push('Talked about social influences');
                    }
                    if (content.toLowerCase().includes('media') || content.toLowerCase().includes('news') || content.toLowerCase().includes('article')) {
                        topics.push('Discussed media influences');
                    }
                    if (content.toLowerCase().includes('experience') || content.toLowerCase().includes('personal') || content.toLowerCase().includes('saw') || content.toLowerCase().includes('noticed')) {
                        topics.push('Shared personal experiences');
                    }
                }
            });
            
            // Remove duplicates and limit to 4-5 key points
            const uniqueTopics = [...new Set(topics)].slice(0, 5);
            
            if (uniqueTopics.length === 0) {
                summary = '• Shared initial thoughts about climate change belief change';
            } else {
                summary = uniqueTopics.map(topic => `• ${topic}`).join('\n\n');
            }
            
            return summary;
        }
        
        // Generate conversation summary as array for validation page
        function generateConversationSummaryArray() {
            const messages = Array.from(chatMessages.querySelectorAll('.message'));
            const assistantMessages = messages.filter(msg => msg.querySelector('.sender-name').textContent === 'Assistant');
            
            // Look for the chatbot's summary in the last few assistant messages
            // Try to find a message containing bullet points or summary structure
            for (let i = assistantMessages.length - 1; i >= Math.max(0, assistantMessages.length - 3); i--) {
                const msg = assistantMessages[i];
                const content = msg.querySelector('.message-content').textContent;
                
                // Check if this message contains a summary with bullet points
                if (content.includes('summarize') || content.includes('summary') || content.includes('key themes')) {
                    const extractedSummary = extractBulletPointsFromSummary(content);
                    if (extractedSummary.length > 0) {
                        console.log('Found chatbot summary with bullet points:', extractedSummary);
                        return extractedSummary;
                    }
                }
            }
            
            // Fallback: look for any message with bullet points
            for (let i = assistantMessages.length - 1; i >= 0; i--) {
                const msg = assistantMessages[i];
                const content = msg.querySelector('.message-content').textContent;
                
                if (content.includes('•') || content.includes('*') || content.includes('-')) {
                    const extractedSummary = extractBulletPointsFromSummary(content);
                    if (extractedSummary.length > 0) {
                        console.log('Found bullet points in assistant message:', extractedSummary);
                        return extractedSummary;
                    }
                }
            }
            
            // Ultimate fallback: use basic topic extraction
            console.log('No chatbot summary found, using fallback generation');
            return generateFallbackSummaryArray();
        }
        
        // Extract bullet points from a chatbot summary message
        function extractBulletPointsFromSummary(summaryText) {
            const bulletPoints = [];
            
            // Split by common bullet point indicators
            const lines = summaryText.split(/[•\*\-]/).filter(line => line.trim().length > 0);
            
            for (let i = 1; i < lines.length; i++) { // Skip the first split (before first bullet)
                let point = lines[i].trim();
                
                // Clean up the bullet point
                point = point.replace(/^[•\*\-\s]+/, ''); // Remove leading bullets/spaces
                point = point.replace(/\s*Does this capture.*$/i, ''); // Remove trailing question
                point = point.replace(/\s*Is there anything.*$/i, ''); // Remove trailing question
                point = point.replace(/\s*Would you like.*$/i, ''); // Remove trailing question
                point = point.replace(/[.!?]*$/, ''); // Remove trailing punctuation
                point = point.trim();
                
                // Only include substantial points
                if (point.length > 10 && !point.toLowerCase().includes('thank you') &&
                    !point.toLowerCase().includes('based on our conversation')) {
                    // Ensure it starts with capital letter and ends with period
                    if (point.length > 0) {
                        point = point.charAt(0).toUpperCase() + point.slice(1);
                        if (!point.endsWith('.')) {
                            point += '.';
                        }
                        bulletPoints.push(point);
                    }
                }
            }
            
            return bulletPoints;
        }
        
        // Fallback summary generation when no real summary is found
        function generateFallbackSummaryArray() {
            const messages = Array.from(chatMessages.querySelectorAll('.message'));
            const userMessages = messages.filter(msg => msg.querySelector('.sender-name').textContent === 'You');
            
            const topics = [];
            
            // Extract key themes from user messages
            userMessages.forEach(msg => {
                const content = msg.querySelector('.message-content').textContent;
                if (content.length > 20) { // Only meaningful messages
                    // Simple keyword extraction
                    if (content.toLowerCase().includes('change') || content.toLowerCase().includes('shift')) {
                        topics.push('Discussed belief change process');
                    }
                    if (content.toLowerCase().includes('evidence') || content.toLowerCase().includes('research') || content.toLowerCase().includes('study')) {
                        topics.push('Mentioned evidence or research');
                    }
                    if (content.toLowerCase().includes('people') || content.toLowerCase().includes('family') || content.toLowerCase().includes('friend')) {
                        topics.push('Talked about social influences');
                    }
                    if (content.toLowerCase().includes('media') || content.toLowerCase().includes('news') || content.toLowerCase().includes('article')) {
                        topics.push('Discussed media influences');
                    }
                    if (content.toLowerCase().includes('experience') || content.toLowerCase().includes('personal') || content.toLowerCase().includes('saw') || content.toLowerCase().includes('noticed')) {
                        topics.push('Shared personal experiences');
                    }
                }
            });
            
            // Remove duplicates and limit to 4-5 key points
            const uniqueTopics = [...new Set(topics)].slice(0, 5);
            
            if (uniqueTopics.length === 0) {
                return ['Shared initial thoughts about climate change belief change'];
            } else {
                return uniqueTopics;
            }
        }
        
        // Save chatbot summary to sessionStorage before redirect
        function saveChatbotSummary() {
            try {
                const summaryArray = generateConversationSummaryArray();
                sessionStorage.setItem('chatbot_summary', JSON.stringify(summaryArray));
                console.log('Chatbot summary saved to sessionStorage:', summaryArray);
            } catch (error) {
                console.error('Error saving chatbot summary:', error);
                // Fallback: save a simple summary
                sessionStorage.setItem('chatbot_summary', JSON.stringify(['Participated in conversation about climate change beliefs']));
            }
        }
        
        // Show 1-minute warning with summary
        async function showOneMinuteWarning() {
            const summary = generateConversationSummary();
            const warningMessage = `We're almost out of time — about one minute left.

${summary}

Is there anything important you'd like to add before we finish?`;
            
            // Add system message
            addMessage({
                role: 'system',
                content: warningMessage,
                timestamp: new Date().toISOString()
            });
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Send message
        async function sendMessage() {
            const content = messageInput.value.trim();
            if (!content || !conversationActive || !conversationId) return;
            
            // Disable input while processing
            messageInput.disabled = true;
            sendButton.disabled = true;
            
            // Add user message to chat
            const userMessage = {
                role: 'user',
                content: content,
                timestamp: new Date().toISOString()
            };
            addMessage(userMessage);
            
            // Clear input
            messageInput.value = '';
            
            try {
                // Send to enhanced API
                const response = await fetch('/chat/reply', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ conversationId, message: content })
                });
                
                if (response.status === 410) {
                    // Time limit exceeded - show brief message and redirect
                    // Add a final assistant-style message to the chat window
                    const messagesDiv = document.getElementById('chatMessages');
                    const endMsg = document.createElement('div');
                    endMsg.className = 'message other-message';
                    endMsg.innerHTML = `
                        <div class="message-header">
                            <span class="sender-name">Assistant</span>
                            <span class="message-time">${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>
                        </div>
                        <div class="message-content">The chat has now ended. Please continue to the final survey.</div>
                    `;
                    messagesDiv.appendChild(endMsg);

                    // Scroll to bottom
                    messagesDiv.scrollTop = messagesDiv.scrollHeight;

                    // Save chatbot summary before redirect
                    saveChatbotSummary();

                    // Redirect after short delay
                    setTimeout(() => {
                        window.location.href = '/exit-survey';
                    }, 2000);
                    return;
                }
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                // Check if session ended
                if (data.sessionEnded) {
                    // Add assistant reply
                    const assistantMessage = {
                        role: 'assistant',
                        content: data.reply,
                        timestamp: new Date().toISOString()
                    };
                    addMessage(assistantMessage);
                    
                    // Show brief message and redirect
                    // Add a final assistant-style message to the chat window
                    const messagesDiv = document.getElementById('chatMessages');
                    const endMsg = document.createElement('div');
                    endMsg.className = 'message other-message';
                    endMsg.innerHTML = `
                        <div class="message-header">
                            <span class="sender-name">Assistant</span>
                            <span class="message-time">${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>
                        </div>
                        <div class="message-content">The chat has now ended. Please continue to the final survey.</div>
                    `;
                    messagesDiv.appendChild(endMsg);

                    // Scroll to bottom
                    messagesDiv.scrollTop = messagesDiv.scrollHeight;

                    // Save chatbot summary before redirect
                    saveChatbotSummary();

                    // Redirect after short delay
                    setTimeout(() => {
                        window.location.href = '/exit-survey';
                    }, 2000);
                    return;
                }
                
                // Add assistant reply
                const assistantMessage = {
                    role: 'assistant',
                    content: data.reply,
                    timestamp: new Date().toISOString()
                };
                addMessage(assistantMessage);
                
            } catch (error) {
                console.error('Error sending message:', error);
                alert('Error sending message. Please try again.');
                
                // Re-add the message to input for retry
                messageInput.value = content;
            } finally {
                // Re-enable input if conversation is still active
                if (conversationActive) {
                    messageInput.disabled = false;
                    updateSendButtonState();
                    messageInput.focus();
                }
            }
        }
        
        function updateSendButtonState() {
            const hasContent = messageInput.value.trim().length > 0;
            sendButton.disabled = !hasContent || !conversationActive;
        }
        
        // End conversation
        async function endConversation(reason) {
            if (!conversationActive) return;
            
            conversationActive = false;
            stopTimer();
            
            messageInput.disabled = true;
            sendButton.disabled = true;
            
            // End conversation (enhanced system handles this automatically)
            // No separate end endpoint needed with new chat system
            
            let reasonText;
            switch(reason) {
                case 'time_limit':
                    reasonText = 'Your 10-minute conversation has ended.';
                    break;
                case 'user_ended':
                    reasonText = 'You ended the conversation early.';
                    break;
                default:
                    reasonText = 'The conversation has ended.';
            }
            
            // Save chatbot summary when conversation ends
            saveChatbotSummary();
            
            document.getElementById('endReason').textContent = reasonText;
            endModal.style.display = 'flex';
        }
        
        // Event listeners
        messageInput.addEventListener('input', updateSendButtonState);
        
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                if (!sendButton.disabled) {
                    sendMessage();
                }
            }
        });
        
        sendButton.addEventListener('click', () => {
            if (!sendButton.disabled) {
                sendMessage();
            }
        });
        
        document.getElementById('continueBtn').addEventListener('click', () => {
            // Summary is already saved when endConversation() was called
            window.location.href = '/exit-survey';
        });
        
        // Handle page unload
        window.addEventListener('beforeunload', () => {
            if (conversationActive && conversationId) {
                // Send end conversation request (may not complete due to page unload)
                navigator.sendBeacon(`/api/conversations/${conversationId}/end`, 
                    JSON.stringify({}));
            }
        });
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', () => {
            initializeConversation();
        });
    </script>
</body>
</html>