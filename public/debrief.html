<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Participant Debrief Sheet</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        .debrief-content {
            max-height: 70vh;
            overflow-y: auto;
            padding: 1.5rem;
            border: 1px solid #e1e8ed;
            border-radius: 8px;
            margin-bottom: 2rem;
            background-color: #fafafa;
            line-height: 1.6;
        }
        
        .debrief-content h1 {
            color: #1a73e8;
            margin-top: 0;
            margin-bottom: 1rem;
            font-size: 1.5rem;
            text-align: center;
        }
        
        .debrief-content h2 {
            color: #1a73e8;
            margin-top: 1.5rem;
            margin-bottom: 0.75rem;
            font-size: 1.2rem;
        }
        
        .debrief-content p {
            margin-bottom: 1rem;
            color: #333;
        }
        
        .debrief-content ul {
            margin-bottom: 1rem;
            padding-left: 1.5rem;
        }
        
        .debrief-content li {
            margin-bottom: 0.5rem;
        }
        
        .contact-info {
            background-color: #f8f9ff;
            border: 1px solid #d4e3fc;
            padding: 1rem;
            border-radius: 6px;
            margin: 1rem 0;
        }
        
        .contact-info strong {
            display: block;
            margin-bottom: 0.5rem;
        }
        
        .contact-link {
            color: #1a73e8;
            text-decoration: none;
        }
        
        .contact-link:hover {
            text-decoration: underline;
        }
        
        .download-section {
            text-align: center;
            margin: 2rem 0;
            padding: 1rem;
            border-top: 1px solid #e1e8ed;
        }
        
        .download-link {
            color: #1a73e8;
            text-decoration: underline;
            cursor: pointer;
            font-size: 0.95rem;
            margin-bottom: 1.5rem;
            display: inline-block;
        }
        
        .download-link:hover {
            color: #0d47a1;
        }
        
        .submit-section {
            text-align: center;
            margin-top: 2rem;
            padding: 1.5rem;
            background-color: #f8f9ff;
            border: 2px solid #1a73e8;
            border-radius: 8px;
        }
        
        .btn-submit {
            background-color: #1a73e8;
            color: white;
            border: none;
            padding: 1rem 2rem;
            font-size: 1.1rem;
            font-weight: 600;
            border-radius: 6px;
            cursor: pointer;
            min-width: 250px;
            transition: background-color 0.2s ease;
        }
        
        .btn-submit:hover {
            background-color: #0d47a1;
        }
        
        .btn-submit:focus {
            outline: 2px solid #4285f4;
            outline-offset: 2px;
        }
        
        .study-title {
            font-style: italic;
            color: #666;
            margin-bottom: 1.5rem;
        }
        
        .thank-you {
            font-size: 1.1rem;
            font-weight: 500;
            color: #1a73e8;
            margin-bottom: 1.5rem;
        }
        
        .completion-code-section {
            text-align: center;
            margin: 2rem 0 1rem 0;
        }
        
        .completion-code-box {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 0 auto;
            max-width: 400px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .completion-text {
            margin: 0 0 1rem 0;
            color: #155724;
            font-size: 1rem;
            font-weight: 500;
        }
        
        .completion-code {
            font-family: 'Courier New', Monaco, monospace;
            font-size: 1.5rem;
            font-weight: bold;
            color: #155724;
            background-color: #f8f9fa;
            border: 1px solid #c3e6cb;
            border-radius: 4px;
            padding: 0.75rem;
            margin: 0;
        
        .copy-instruction {
            margin: 0.75rem 0 0 0;
            color: #666;
            font-size: 0.875rem;
            font-style: italic;
        }
        
        .copy-feedback {
            display: none;
            margin: 0.5rem 0 0 0;
            color: #155724;
            font-size: 0.875rem;
            font-weight: 500;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .copy-feedback.show {
            display: block;
            opacity: 1;
        }
        
        .completion-code:hover {
            background-color: #e9ecef;
            border-color: #a3c7a3;
            cursor: pointer;
        }
            user-select: text;
            cursor: text;
            letter-spacing: 2px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Study Debrief</h1>
        </div>
        
        <div class="content">
            <div class="debrief-content" id="debriefContent">
                <h1>Participant Debrief Sheet</h1>
                
                <p class="study-title"><strong>Study Title:</strong> Examining Belief Change Narratives through Dialogues with AI</p>
                
                <p class="thank-you">Thank you for participating in our research study. We appreciate the time and effort you've contributed to this important research.</p>
                
                <h2>Purpose of the Study</h2>
                <p>The primary aim of this study was to investigate people's changes of mind and belief towards topics relating to technology and science.</p>
                
                <h2>What We Did</h2>
                <p>In this study, you completed surveys about your attitudes toward climate change and interacted with an AI chatbot. The AI you interacted with was not programmed to persuade you in any particular direction, but rather to engage in an open-ended dialogue.</p>
                
                <h2>Factual Information</h2>
                <p>To ensure you have access to reliable information about climate change, we recommend consulting the following reputable source:</p>
                <ul>
                    <li>The Intergovernmental Panel on Climate Change.</li>
                </ul>
                
                <h2>Why This Research is Important</h2>
                <p>Understanding attitudes towards climate change and the reasons why people change their minds about climate change helps us understand how beliefs and opinions change and evolve.</p>
                
                <h2>Confidentiality Reminder</h2>
                <p>As a reminder, all the data collected in this study will be kept confidential and anonymous. Your responses will not be identifiable in any published results.</p>
                
                    <p class="copy-instruction">Click the code above to copy it to your clipboard</p>
                    <div class="copy-feedback" id="copyFeedback">Copied to clipboard!</div>
                <h2>Further Questions or Concerns</h2>
                <p>If you have any questions about this research or your participation, please don't hesitate to contact the lead researcher:</p>
                
                <div class="contact-info">
                    <strong>David Cheney</strong>
                    Email: <a href="mailto:d.cheney@uq.edu.au" class="contact-link">d.cheney@uq.edu.au</a>
                </div>
                
                <p>If you have any concerns about the ethical conduct of this research, you may contact the University of Queensland Ethics Coordinator on <a href="tel:+61733653924" class="contact-link">+617 3365 3924</a> or email <a href="mailto:humanethics@research.uq.edu.au" class="contact-link">humanethics@research.uq.edu.au</a>.</p>
                
                <p><strong>Please click the button below to be redirected back to Prolific to register your submission</strong></p>
            </div>
            
            
            <div class="completion-code-section">
                <div class="completion-code-box">
                    <p class="completion-text">Your Prolific completion code is:</p>
                    <div class="completion-code" id="completionCode">CNCTZ833</div>
                </div>
            </div>
            
            <div class="submit-section">
                <button type="button" class="btn-submit" id="submitBtn">Submit and Return to Prolific</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Check if user completed the study
            const participantId = sessionStorage.getItem('participant_id');
            if (!participantId) {
                alert('Please complete the study from the beginning.');
            
            initializeCopyToClipboard();
                window.location.href = '/';
                return;
            }
            
            initializeDownload();
            initializeSubmit();
        });
        
        function initializeDownload() {
            const downloadLink = document.getElementById('downloadDebriefPdf');
            
            downloadLink.addEventListener('click', function(e) {
                e.preventDefault();
                generateDebriefPDF();
            });
        }
        
        function generateDebriefPDF() {
            try {
                // Get the debrief content
                const content = document.getElementById('debriefContent').innerText;
                
                // Create a blob with the content
                const blob = new Blob([content], { type: 'text/plain' });
                
                // Create download link
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'Participant_Debrief_Sheet.pdf';
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
                console.log('Debrief sheet downloaded as text file');
            } catch (error) {
                console.error('Error generating download:', error);
                alert('Download feature is currently unavailable. Please copy the text if needed.');
            }
        }
        
        function initializeSubmit() {
            const submitBtn = document.getElementById('submitBtn');
            
            submitBtn.addEventListener('click', async function() {
                // Disable button during submission
                submitBtn.disabled = true;
                submitBtn.textContent = 'Submitting...';
                
                try {
                    // Prepare completion data
                    const completionData = {
                        participant_id: sessionStorage.getItem('participant_id'),
                        prolific_id: sessionStorage.getItem('prolific_id'),
                        completed_at: new Date().toISOString(),
                        survey_completed: true
                    };
                    
                    console.log('Submitting final survey completion:', completionData);
                    
                    // Submit completion data to server
                    const response = await fetch('/api/complete-survey', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(completionData)
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const result = await response.json();
                    console.log('Survey completion successful:', result);
                    
                    // Store completion data locally
                    sessionStorage.setItem('completion_data', JSON.stringify(completionData));
                    
                    // Get Prolific completion URL from server response or environment
                    const prolificCompletionUrl = result.prolificCompletionUrl || getProlificCompletionUrl();
                    
                    if (prolificCompletionUrl) {
                        console.log('Redirecting to Prolific completion URL:', prolificCompletionUrl);
                        window.location.href = prolificCompletionUrl;
                    } else {
                        // Fallback: show completion message
                        alert('Thank you for completing the study! Please return to Prolific to register your submission.');
                        console.log('Study completed successfully - no Prolific URL available');
                    }
                    
                } catch (error) {
                    console.error('Error submitting survey completion:', error);
                    
                    // Re-enable button and show error
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Submit and Return to Prolific';
                    
                    // Show error but allow fallback completion
                    const continueAnyway = confirm('There was an error submitting your completion data to the server. Would you like to continue to Prolific anyway? (Your previous responses have been saved)');
                    
                    if (continueAnyway) {
                        // Try to redirect to Prolific even with submission error
                        const prolificCompletionUrl = getProlificCompletionUrl();
                        if (prolificCompletionUrl) {
                            console.log('Redirecting to Prolific despite submission error');
                            window.location.href = prolificCompletionUrl;
                        } else {
                            alert('Thank you for completing the study! Please return to Prolific to register your submission.');
                        }
                    }
                }
            });
        }
        
        function getProlificCompletionUrl() {
            // Try to get completion URL from various sources
            const urlParams = new URLSearchParams(window.location.search);
            const prolificId = sessionStorage.getItem('prolific_id');
            
            // Check for completion URL in URL parameters (from environment)
            const returnUrl = urlParams.get('PROLIFIC_COMPLETION_URL') ||
                             urlParams.get('completion_url') ||
                             urlParams.get('return_url');
            
            if (returnUrl) {
                return returnUrl;
            }
            
            // Check if there's a completion URL stored from server environment
        
        function initializeCopyToClipboard() {
            const completionCodeElement = document.getElementById('completionCode');
            const copyFeedback = document.getElementById('copyFeedback');
            
            completionCodeElement.addEventListener('click', async function() {
                try {
                    const completionCode = this.textContent.trim();
                    
                    // Use modern clipboard API if available
                    if (navigator.clipboard && window.isSecureContext) {
                        await navigator.clipboard.writeText(completionCode);
                    } else {
                        // Fallback for older browsers
                        const textArea = document.createElement('textarea');
                        textArea.value = completionCode;
                        textArea.style.position = 'fixed';
                        textArea.style.left = '-999999px';
                        textArea.style.top = '-999999px';
                        document.body.appendChild(textArea);
                        textArea.focus();
                        textArea.select();
                        document.execCommand('copy');
                        textArea.remove();
                    }
                    
                    // Show feedback
                    copyFeedback.classList.add('show');
                    
                    // Hide feedback after 2 seconds
                    setTimeout(() => {
                        copyFeedback.classList.remove('show');
                    }, 2000);
                    
                    console.log('Completion code copied to clipboard:', completionCode);
                    
                } catch (error) {
                    console.error('Failed to copy completion code:', error);
                    // Show error feedback
                    copyFeedback.textContent = 'Failed to copy - please select manually';
                    copyFeedback.classList.add('show');
                    
                    setTimeout(() => {
                        copyFeedback.textContent = 'Copied to clipboard!';
                        copyFeedback.classList.remove('show');
                    }, 3000);
                }
            });
            
            // Add keyboard accessibility
            completionCodeElement.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    this.click();
                }
            });
            
            // Add title attribute for tooltip
            completionCodeElement.setAttribute('title', 'Click to copy to clipboard');
            completionCodeElement.setAttribute('tabindex', '0');
            completionCodeElement.setAttribute('role', 'button');
        }
            const storedCompletionUrl = sessionStorage.getItem('prolific_completion_url');
            if (storedCompletionUrl) {
                return storedCompletionUrl;
            }
            
            // Construct standard Prolific completion URL if we have the participant ID
            if (prolificId) {
                return `https://app.prolific.com/submissions/complete?cc=CNCTZ833&prolific_pid=${prolificId}`;
            }
            
            // Default Prolific completion page
            return 'https://app.prolific.com/submissions/complete?cc=CNCTZ833';
        }
        
        // Keyboard accessibility for submit button
        document.getElementById('submitBtn').addEventListener('keypress', function(e) {
            if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                this.click();
            }
        });
        
        // Prevent back navigation by disabling browser back button
        window.addEventListener('popstate', function(e) {
            e.preventDefault();
            if (confirm('Are you sure you want to leave? Your study completion may not be recorded.')) {
                // Allow navigation if user really wants to go back
                window.history.back();
            } else {
                // Push the current state back to prevent navigation
                window.history.pushState(null, '', window.location.href);
            }
        });
        
        // Push initial state to enable back button prevention
        window.history.pushState(null, '', window.location.href);
    </script>
</body>
</html>