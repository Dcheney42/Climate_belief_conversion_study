<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Climate Change Survey</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Climate Change Views Survey</h1>
            <p class="subtitle">Please answer the following questions about your background and views</p>
        </div>
        
        <div class="content">
            <form id="surveyForm" class="survey-form">
                <!-- Age -->
                <div class="demo-field-card">
                    <label for="age" class="field-label">Age <span class="required">*</span></label>
                    <input type="number" id="age" name="age" min="16" max="120" required
                           class="field-input" placeholder="Enter your age">
                    <div class="field-error" id="age-error"></div>
                </div>

                <!-- Gender Identity -->
                <div class="demo-field-card">
                    <label class="field-label">Gender identity <span class="required">*</span></label>
                    <div class="radio-group">
                        <label class="radio-label">
                            <input type="radio" name="gender" value="Woman" required>
                            <span class="radio-text">Woman</span>
                        </label>
                        <label class="radio-label">
                            <input type="radio" name="gender" value="Man" required>
                            <span class="radio-text">Man</span>
                        </label>
                        <label class="radio-label">
                            <input type="radio" name="gender" value="Non-binary" required>
                            <span class="radio-text">Non-binary</span>
                        </label>
                        <label class="radio-label">
                            <input type="radio" name="gender" value="Other" required>
                            <span class="radio-text">Other</span>
                        </label>
                    </div>
                    <div class="field-error" id="gender-error"></div>
                </div>

                <!-- Highest Education -->
                <div class="demo-field-card">
                    <label for="education" class="field-label">Highest education <span class="required">*</span></label>
                    <select id="education" name="education" required class="field-input">
                        <option value="">Select your highest education</option>
                        <option value="Less than high school">Less than high school</option>
                        <option value="High school">High school</option>
                        <option value="Vocational/TAFE">Vocational/TAFE</option>
                        <option value="Bachelor">Bachelor</option>
                        <option value="Honours">Honours</option>
                        <option value="Masters">Masters</option>
                        <option value="Doctorate">Doctorate</option>
                    </select>
                    <div class="field-error" id="education-error"></div>
                </div>

                <!-- Country -->
                <div class="demo-field-card">
                    <label for="country" class="field-label">Country <span class="required">*</span></label>
                    <select id="country" name="country" required class="field-input">
                        <option value="">Select your country</option>
                        <option value="Australia">Australia</option>
                        <option value="Canada">Canada</option>
                        <option value="Germany">Germany</option>
                        <option value="United Kingdom">United Kingdom</option>
                        <option value="United States">United States</option>
                        <option value="New Zealand">New Zealand</option>
                        <option value="France">France</option>
                        <option value="Japan">Japan</option>
                        <option value="South Korea">South Korea</option>
                        <option value="Other">Other</option>
                    </select>
                    <div class="field-error" id="country-error"></div>
                </div>

                <!-- Political Affiliation -->
                <div class="demo-field-card">
                    <label class="field-label">Political affiliation <span class="required">*</span></label>
                    <div class="likert-scale">
                        <div class="likert-anchors">
                            <span class="anchor-left">Very liberal</span>
                            <span class="anchor-right">Very conservative</span>
                        </div>
                        <div class="likert-options">
                            <label class="likert-option">
                                <input type="radio" name="politicalAffiliation" value="1" required>
                                <span class="likert-number">1</span>
                            </label>
                            <label class="likert-option">
                                <input type="radio" name="politicalAffiliation" value="2" required>
                                <span class="likert-number">2</span>
                            </label>
                            <label class="likert-option">
                                <input type="radio" name="politicalAffiliation" value="3" required>
                                <span class="likert-number">3</span>
                            </label>
                            <label class="likert-option">
                                <input type="radio" name="politicalAffiliation" value="4" required>
                                <span class="likert-number">4</span>
                            </label>
                            <label class="likert-option">
                                <input type="radio" name="politicalAffiliation" value="5" required>
                                <span class="likert-number">5</span>
                            </label>
                            <label class="likert-option">
                                <input type="radio" name="politicalAffiliation" value="6" required>
                                <span class="likert-number">6</span>
                            </label>
                            <label class="likert-option">
                                <input type="radio" name="politicalAffiliation" value="7" required>
                                <span class="likert-number">7</span>
                            </label>
                        </div>
                    </div>
                    <div class="field-error" id="politicalAffiliation-error"></div>
                </div>

                <!-- Prior Belief about Climate Change -->
                <div class="demo-field-card">
                    <label class="field-label">Prior belief about climate change <span class="required">*</span></label>
                    <div class="likert-scale">
                        <div class="likert-anchors">
                            <span class="anchor-left">Definitely not caused by humans</span>
                            <span class="anchor-right">Definitely caused by humans</span>
                        </div>
                        <div class="likert-options">
                            <label class="likert-option">
                                <input type="radio" name="priorClimateBelief" value="1" required>
                                <span class="likert-number">1</span>
                            </label>
                            <label class="likert-option">
                                <input type="radio" name="priorClimateBelief" value="2" required>
                                <span class="likert-number">2</span>
                            </label>
                            <label class="likert-option">
                                <input type="radio" name="priorClimateBelief" value="3" required>
                                <span class="likert-number">3</span>
                            </label>
                            <label class="likert-option">
                                <input type="radio" name="priorClimateBelief" value="4" required>
                                <span class="likert-number">4</span>
                            </label>
                            <label class="likert-option">
                                <input type="radio" name="priorClimateBelief" value="5" required>
                                <span class="likert-number">5</span>
                            </label>
                            <label class="likert-option">
                                <input type="radio" name="priorClimateBelief" value="6" required>
                                <span class="likert-number">6</span>
                            </label>
                            <label class="likert-option">
                                <input type="radio" name="priorClimateBelief" value="7" required>
                                <span class="likert-number">7</span>
                            </label>
                        </div>
                    </div>
                    <div class="field-error" id="priorClimateBelief-error"></div>
                </div>

                <!-- Current Belief about Climate Change -->
                <div class="demo-field-card">
                    <label class="field-label">Current belief about climate change <span class="required">*</span></label>
                    <div class="likert-scale">
                        <div class="likert-anchors">
                            <span class="anchor-left">Definitely not caused by humans</span>
                            <span class="anchor-right">Definitely caused by humans</span>
                        </div>
                        <div class="likert-options">
                            <label class="likert-option">
                                <input type="radio" name="currentClimateBelief" value="1" required>
                                <span class="likert-number">1</span>
                            </label>
                            <label class="likert-option">
                                <input type="radio" name="currentClimateBelief" value="2" required>
                                <span class="likert-number">2</span>
                            </label>
                            <label class="likert-option">
                                <input type="radio" name="currentClimateBelief" value="3" required>
                                <span class="likert-number">3</span>
                            </label>
                            <label class="likert-option">
                                <input type="radio" name="currentClimateBelief" value="4" required>
                                <span class="likert-number">4</span>
                            </label>
                            <label class="likert-option">
                                <input type="radio" name="currentClimateBelief" value="5" required>
                                <span class="likert-number">5</span>
                            </label>
                            <label class="likert-option">
                                <input type="radio" name="currentClimateBelief" value="6" required>
                                <span class="likert-number">6</span>
                            </label>
                            <label class="likert-option">
                                <input type="radio" name="currentClimateBelief" value="7" required>
                                <span class="likert-number">7</span>
                            </label>
                        </div>
                    </div>
                    <div class="field-error" id="currentClimateBelief-error"></div>
                </div>

                <!-- Consent -->
                <div class="demo-field-card">
                    <div class="checkbox-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="consent" name="consent" required>
                            <span class="checkbox-text">I consent to the use of my anonymised responses. <span class="required">*</span></span>
                        </label>
                    </div>
                    <div class="field-error" id="consent-error"></div>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn-primary" id="submitBtn" disabled>Submit Survey</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Check if user came from consent
            if (!sessionStorage.getItem('consent_data')) {
                alert('Please complete the consent form first.');
                window.location.href = '/consent';
                return;
            }

            // Initialize form validation
            initializeFormValidation();
        });

        function initializeFormValidation() {
            const form = document.getElementById('surveyForm');
            const submitBtn = document.getElementById('submitBtn');
            
            // Add event listeners for real-time validation
            const inputs = form.querySelectorAll('input, select');
            inputs.forEach(input => {
                input.addEventListener('change', validateForm);
                input.addEventListener('input', function() {
                    clearFieldError(this.name || this.id);
                });
            });

            // Initial validation check
            validateForm();
        }

        function validateForm() {
            const submitBtn = document.getElementById('submitBtn');
            let isValid = true;

            // Clear all errors first
            document.querySelectorAll('.field-error').forEach(error => {
                error.classList.remove('show');
            });
            document.querySelectorAll('.field-input').forEach(input => {
                input.classList.remove('error');
            });

            // Validate age
            const age = document.getElementById('age').value;
            if (!age || age < 16 || age > 120) {
                showFieldError('age', 'Age must be between 16 and 120');
                isValid = false;
            }

            // Validate gender
            const gender = document.querySelector('input[name="gender"]:checked');
            if (!gender) {
                showFieldError('gender', 'Please select your gender identity');
                isValid = false;
            }

            // Validate education
            const education = document.getElementById('education').value;
            if (!education) {
                showFieldError('education', 'Please select your highest education');
                isValid = false;
            }

            // Validate country
            const country = document.getElementById('country').value;
            if (!country) {
                showFieldError('country', 'Please select your country');
                isValid = false;
            }

            // Validate political affiliation
            const political = document.querySelector('input[name="politicalAffiliation"]:checked');
            if (!political) {
                showFieldError('politicalAffiliation', 'Please rate your political affiliation');
                isValid = false;
            }

            // Validate prior climate belief
            const priorBelief = document.querySelector('input[name="priorClimateBelief"]:checked');
            if (!priorBelief) {
                showFieldError('priorClimateBelief', 'Please rate your prior belief about climate change');
                isValid = false;
            }

            // Validate current climate belief
            const currentBelief = document.querySelector('input[name="currentClimateBelief"]:checked');
            if (!currentBelief) {
                showFieldError('currentClimateBelief', 'Please rate your current belief about climate change');
                isValid = false;
            }

            // Validate consent
            const consent = document.getElementById('consent').checked;
            if (!consent) {
                showFieldError('consent', 'Consent is required to proceed');
                isValid = false;
            }

            // Enable/disable submit button
            submitBtn.disabled = !isValid;
            
            return isValid;
        }

        function showFieldError(fieldName, message) {
            const errorElement = document.getElementById(fieldName + '-error');
            const inputElement = document.getElementById(fieldName) ||
                                 document.querySelector(`input[name="${fieldName}"]`);
            
            if (errorElement) {
                errorElement.textContent = message;
                errorElement.classList.add('show');
            }
            
            if (inputElement && inputElement.classList) {
                inputElement.classList.add('error');
            }
        }

        function clearFieldError(fieldName) {
            const errorElement = document.getElementById(fieldName + '-error');
            const inputElement = document.getElementById(fieldName) ||
                                 document.querySelector(`input[name="${fieldName}"]`);
            
            if (errorElement) {
                errorElement.classList.remove('show');
            }
            
            if (inputElement && inputElement.classList) {
                inputElement.classList.remove('error');
            }
        }

        document.getElementById('surveyForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Final validation check
            if (!validateForm()) {
                alert('Please complete all required fields before submitting.');
                return;
            }
            
            // Collect form data
            const formData = new FormData(this);
            const surveyData = {
                prolific_id: sessionStorage.getItem('prolific_id') || null,
                age: parseInt(formData.get('age')),
                gender: formData.get('gender'),
                education: formData.get('education'),
                country: formData.get('country'),
                political_orientation: parseInt(formData.get('politicalAffiliation')),
                prior_belief: parseInt(formData.get('priorClimateBelief')),
                current_belief: parseInt(formData.get('currentClimateBelief')),
                consent: formData.get('consent') === 'on'
            };
            
            console.log('Submitting survey data:', surveyData);
            
            // Disable submit button during submission
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Submitting...';
            
            // Submit to server
            fetch('/survey/submit', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(surveyData)
            })
            .then(response => {
                console.log('Received response:', response);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.participantId) {
                    // Store participant ID
                    sessionStorage.setItem('participant_id', data.participantId);
                    // Clear any old survey data
                    sessionStorage.removeItem('survey_responses');
                    
                    // Check eligibility and route accordingly
                    if (data.eligible === true) {
                        // Eligible participants continue to chat
                        console.log('Participant eligible - proceeding to chat');
                        window.location.href = `/chat/${data.participantId}`;
                    } else {
                        // Ineligible participants go to disqualification page
                        console.log('Participant not eligible - redirecting to disqualification page');
                        window.location.href = '/disqualified';
                    }
                } else {
                    console.error('Server error:', data);
                    alert(`Error submitting survey: ${data.error || 'Unknown error'}. Please try again.`);
                    // Re-enable submit button
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Submit Survey';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert(`Error submitting survey: ${error.message}. Please try again.`);
                // Re-enable submit button
                submitBtn.disabled = false;
                submitBtn.textContent = 'Submit Survey';
            });
        });

        // Add keyboard navigation for Likert scales
        document.querySelectorAll('.likert-scale').forEach(scale => {
            const radios = scale.querySelectorAll('input[type="radio"]');
            radios.forEach((radio, index) => {
                radio.addEventListener('keydown', function(e) {
                    if (e.key === 'ArrowLeft' && index > 0) {
                        e.preventDefault();
                        radios[index - 1].focus();
                        radios[index - 1].checked = true;
                        validateForm();
                    } else if (e.key === 'ArrowRight' && index < radios.length - 1) {
                        e.preventDefault();
                        radios[index + 1].focus();
                        radios[index + 1].checked = true;
                        validateForm();
                    }
                });
            });
        });
    </script>
</body>
</html>