<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Climate Change Survey</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Climate Change Views Survey</h1>
            <p class="subtitle">Please answer the following questions about your background and views</p>
        </div>
        
        <div class="content">
            <form id="surveyForm" class="survey-form">
                <div class="form-group">
                    <label for="prolific_id">Prolific ID (optional):</label>
                    <input type="text" id="prolific_id" name="prolific_id" placeholder="Enter your Prolific ID if you have one">
                </div>

                <div class="form-group">
                    <label for="age">Age:</label>
                    <input type="number" id="age" name="age" min="18" max="100" required placeholder="Enter your age">
                </div>

                <div class="form-group">
                    <label for="gender">Gender:</label>
                    <select id="gender" name="gender" required>
                        <option value="">Select your gender</option>
                        <option value="male">Male</option>
                        <option value="female">Female</option>
                        <option value="non-binary">Non-binary</option>
                        <option value="prefer-not-to-say">Prefer not to say</option>
                        <option value="other">Other</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="country">Country:</label>
                    <select id="country" name="country" required>
                        <option value="">Select your country</option>
                        <option value="australia">Australia</option>
                        <option value="canada">Canada</option>
                        <option value="germany">Germany</option>
                        <option value="uk">United Kingdom</option>
                        <option value="usa">United States</option>
                        <option value="other">Other</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="education">Education level:</label>
                    <select id="education" name="education" required>
                        <option value="">Select your education level</option>
                        <option value="high-school">High school or equivalent</option>
                        <option value="some-college">Some college</option>
                        <option value="bachelors">Bachelor's degree</option>
                        <option value="masters">Master's degree</option>
                        <option value="phd">PhD or equivalent</option>
                        <option value="other">Other</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="political_orientation">Political orientation:</label>
                    <select id="political_orientation" name="political_orientation" required>
                        <option value="">Select your political orientation</option>
                        <option value="very-liberal">Very liberal</option>
                        <option value="liberal">Liberal</option>
                        <option value="slightly-liberal">Slightly liberal</option>
                        <option value="moderate">Moderate</option>
                        <option value="slightly-conservative">Slightly conservative</option>
                        <option value="conservative">Conservative</option>
                        <option value="very-conservative">Very conservative</option>
                        <option value="prefer-not-to-say">Prefer not to say</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="prior_belief">Prior belief about climate change:</label>
                    <select id="prior_belief" name="prior_belief" required>
                        <option value="">Select your prior belief</option>
                        <option value="strongly-agree-human">Strongly agree it's human-caused</option>
                        <option value="agree-human">Agree it's human-caused</option>
                        <option value="somewhat-agree-human">Somewhat agree it's human-caused</option>
                        <option value="neutral">Neutral/Unsure</option>
                        <option value="somewhat-disagree-human">Somewhat disagree it's human-caused</option>
                        <option value="disagree-human">Disagree it's human-caused</option>
                        <option value="strongly-disagree-human">Strongly disagree it's human-caused</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="current_belief">Current belief about climate change:</label>
                    <select id="current_belief" name="current_belief" required>
                        <option value="">Select your current belief</option>
                        <option value="strongly-agree-human">Strongly agree it's human-caused</option>
                        <option value="agree-human">Agree it's human-caused</option>
                        <option value="somewhat-agree-human">Somewhat agree it's human-caused</option>
                        <option value="neutral">Neutral/Unsure</option>
                        <option value="somewhat-disagree-human">Somewhat disagree it's human-caused</option>
                        <option value="disagree-human">Disagree it's human-caused</option>
                        <option value="strongly-disagree-human">Strongly disagree it's human-caused</option>
                    </select>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn-primary">Submit Survey</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Check if user came from consent
            if (!sessionStorage.getItem('consent_data')) {
                alert('Please complete the consent form first.');
                window.location.href = '/consent';
                return;
            }

            // Load prolific_id from session storage if available
            const prolificId = sessionStorage.getItem('prolific_id');
            if (prolificId) {
                document.getElementById('prolific_id').value = prolificId;
            }
        });

        document.getElementById('surveyForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Collect form data
            const formData = new FormData(this);
            const surveyData = {};
            
            for (let [key, value] of formData.entries()) {
                if (value.trim()) {
                    surveyData[key] = value.trim();
                }
            }
            
            // Convert age to number
            if (surveyData.age) {
                surveyData.age = parseInt(surveyData.age);
            }
            
            console.log('Submitting survey data:', surveyData);
            
            // Submit to server
            fetch('/survey/submit', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(surveyData)
            })
            .then(response => {
                console.log('Received response:', response);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.participantId) {
                    // Store participant ID
                    sessionStorage.setItem('participant_id', data.participantId);
                    // Clear any old survey data
                    sessionStorage.removeItem('survey_responses');
                    // Redirect to chat with participant ID
                    window.location.href = `/chat/${data.participantId}`;
                } else {
                    console.error('Server error:', data);
                    alert(`Error submitting survey: ${data.error || 'Unknown error'}. Please try again.`);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert(`Error submitting survey: ${error.message}. Please try again.`);
            });
        });
    </script>
</body>
</html>