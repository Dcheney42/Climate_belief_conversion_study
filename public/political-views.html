<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Political Views</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Political Views</h1>
            <p class="subtitle">Question <span id="currentQuestion">3</span> of <span id="totalQuestions">5</span></p>
        </div>
        
        <div class="content">
            <form id="politicalViewsForm" class="survey-form">
                <div class="demo-field-card">
                    <div id="questionsContainer">
                        <!-- Questions will be dynamically generated here -->
                    </div>
                </div>
                
                <div class="form-actions">
                    <div class="general-error" id="generalError" role="alert" style="display: none;"></div>
                    <div class="navigation-buttons">
                        <button type="button" class="btn-secondary" id="previousBtn">Previous</button>
                        <button type="submit" class="btn-primary" id="nextBtn">Next</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Political views questions
        const politicalQuestions = [
            {
                id: 'economic_issues',
                text: 'When it comes to economic issues (such as taxation, government spending, welfare, and the role of government in the economy), where would you place yourself?',
                leftLabel: 'Very liberal/Left',
                rightLabel: 'Very conservative/Right'
            },
            {
                id: 'social_issues',
                text: 'When it comes to social issues (such as abortion, same-sex marriage, and law and order), where would you place yourself?',
                leftLabel: 'Very liberal/Left',
                rightLabel: 'Very conservative/Right'
            }
        ];

        // State management
        let displayOrder = [];
        let participantId = null;

        document.addEventListener('DOMContentLoaded', function() {
            // Check if user came from matrix page
            const demographicsData = sessionStorage.getItem('demographics_data');
            if (!demographicsData) {
                alert('Please complete the previous pages first.');
                window.location.href = '/survey.html';
                return;
            }

            // Initialize participant ID for randomization
            participantId = generateParticipantId();
            
            // Generate randomized order for questions
            displayOrder = generateRandomizedOrder();
            
            // Store display order for data analysis
            sessionStorage.setItem('political_views_order', JSON.stringify(displayOrder));

            // Initialize the questions
            initializeQuestions();
            
            // Initialize form validation
            initializeFormValidation();
        });

        function generateParticipantId() {
            // Use existing participant data or generate temporary ID for randomization
            const demographics = JSON.parse(sessionStorage.getItem('demographics_data') || '{}');
            return demographics.participantId || 'temp_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        function generateRandomizedOrder() {
            // Create array of indices
            const indices = Array.from({ length: politicalQuestions.length }, (_, i) => i);
            
            // Simple seeded shuffle based on participant ID
            const seed = hashCode(participantId);
            const rng = seededRandom(seed);
            
            // Fisher-Yates shuffle with seeded random
            for (let i = indices.length - 1; i > 0; i--) {
                const j = Math.floor(rng() * (i + 1));
                [indices[i], indices[j]] = [indices[j], indices[i]];
            }
            
            return indices;
        }

        function hashCode(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash; // Convert to 32bit integer
            }
            return Math.abs(hash);
        }

        function seededRandom(seed) {
            let m = 0x80000000; // 2**31
            let a = 1103515245;
            let c = 12345;
            
            return function() {
                seed = (a * seed + c) % m;
                return seed / (m - 1);
            };
        }

        function initializeQuestions() {
            const container = document.getElementById('questionsContainer');
            
            displayOrder.forEach((questionIndex, displayIndex) => {
                const question = politicalQuestions[questionIndex];
                const questionElement = createQuestionElement(question, displayIndex);
                container.appendChild(questionElement);
            });
        }

        function createQuestionElement(question, displayIndex) {
            const questionDiv = document.createElement('div');
            questionDiv.className = 'political-question';
            questionDiv.setAttribute('data-question-id', question.id);
            
            // Check if mobile
            const isMobile = window.innerWidth <= 768;
            
            questionDiv.innerHTML = `
                <div class="question-text">${question.text}</div>
                <div class="scale-container">
                    <div class="scale-labels">
                        <span class="scale-label-left">${question.leftLabel}</span>
                        <span class="scale-label-right">${question.rightLabel}</span>
                    </div>
                    <div class="scale-wrapper">
                        <div class="scale-numbers">
                            <span>1</span>
                            <span>2</span>
                            <span>3</span>
                            <span>4</span>
                            <span>5</span>
                            <span>6</span>
                            <span>7</span>
                        </div>
                        <div class="scale-options">
                            ${Array.from({ length: 7 }, (_, i) => `
                                <label class="scale-option">
                                    <input type="radio" 
                                           name="${question.id}" 
                                           value="${i + 1}" 
                                           data-question-id="${question.id}">
                                    <span class="scale-circle"></span>
                                </label>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
            
            return questionDiv;
        }

        function initializeFormValidation() {
            const form = document.getElementById('politicalViewsForm');
            const previousBtn = document.getElementById('previousBtn');
            const nextBtn = document.getElementById('nextBtn');

            // Previous button navigation
            previousBtn.addEventListener('click', function() {
                window.location.href = '/cc-views-matrix.html';
            });

            // Form submission
            form.addEventListener('submit', handleFormSubmit);

            // Handle responsive layout changes
            window.addEventListener('resize', handleResize);
        }

        function handleResize() {
            // Rebuild questions for responsive layout
            const container = document.getElementById('questionsContainer');
            const currentValues = {};
            
            // Save current values
            const radioButtons = document.querySelectorAll('input[type="radio"]:checked');
            radioButtons.forEach(radio => {
                currentValues[radio.getAttribute('data-question-id')] = radio.value;
            });
            
            // Clear and rebuild
            container.innerHTML = '';
            initializeQuestions();
            
            // Restore values
            Object.keys(currentValues).forEach(questionId => {
                const radio = document.querySelector(`input[name="${questionId}"][value="${currentValues[questionId]}"]`);
                if (radio) {
                    radio.checked = true;
                }
            });
        }

        function handleFormSubmit(e) {
            e.preventDefault();
            
            // Collect all responses (including null for unanswered questions)
            const responses = {};
            const metaData = {};
            
            politicalQuestions.forEach(question => {
                const selectedRadio = document.querySelector(`input[name="${question.id}"]:checked`);
                responses[question.id] = selectedRadio ? parseInt(selectedRadio.value) : null;
                metaData[question.id + '_answered'] = selectedRadio !== null;
            });
            
            // Get existing demographics data
            const demographicsData = JSON.parse(sessionStorage.getItem('demographics_data'));
            const displayOrder = JSON.parse(sessionStorage.getItem('political_views_order'));
            
            // Combine all data
            const politicalViewsData = {
                ...demographicsData,
                // Political views responses
                ...responses,
                // Metadata
                ...metaData,
                // Display order for analysis
                political_views_order: displayOrder
            };
            
            console.log('Political views survey completed, storing data:', politicalViewsData);
            
            // Store updated data for next page
            sessionStorage.setItem('demographics_data', JSON.stringify(politicalViewsData));
            
            // Proceed to Views on Climate Change page
            window.location.href = '/views.html';
        }
    </script>

    <style>
        .political-question {
            margin-bottom: 2.5rem;
            padding-bottom: 2rem;
            border-bottom: 1px solid #eee;
        }

        .political-question:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .question-text {
            font-size: 1rem;
            line-height: 1.5;
            color: #333;
            margin-bottom: 1.5rem;
            font-weight: 500;
        }

        .scale-container {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .scale-labels {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }

        .scale-label-left,
        .scale-label-right {
            font-size: 0.875rem;
            color: #666;
            font-weight: 500;
        }

        .scale-wrapper {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .scale-numbers {
            display: flex;
            justify-content: space-between;
            font-size: 0.875rem;
            color: #666;
            font-weight: 500;
        }

        .scale-options {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .scale-option {
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .scale-option input[type="radio"] {
            display: none;
        }

        .scale-circle {
            width: 20px;
            height: 20px;
            border: 2px solid #ddd;
            border-radius: 50%;
            background: white;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .scale-option input[type="radio"]:checked + .scale-circle {
            border-color: #007bff;
            background: #007bff;
        }

        .scale-option input[type="radio"]:checked + .scale-circle::after {
            content: '';
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: white;
        }

        .scale-option:hover .scale-circle {
            border-color: #007bff;
            transform: scale(1.1);
        }

        .navigation-buttons {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
        }

        .btn-secondary {
            background-color: #6c757d;
            color: white;
            border: none;
            padding: 0.75rem 2rem;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .btn-secondary:hover {
            background-color: #545b62;
        }

        /* Mobile styles */
        @media (max-width: 768px) {
            .question-text {
                font-size: 0.95rem;
            }

            .scale-labels {
                flex-direction: column;
                gap: 0.25rem;
                text-align: center;
                margin-bottom: 1rem;
            }

            .scale-label-left::before {
                content: "1 = ";
                font-weight: bold;
            }

            .scale-label-right::before {
                content: "7 = ";
                font-weight: bold;
            }

            .scale-numbers {
                font-size: 0.8rem;
            }

            .scale-circle {
                width: 24px;
                height: 24px;
            }

            .navigation-buttons {
                flex-direction: column;
            }

            .btn-primary,
            .btn-secondary {
                width: 100%;
                margin: 0.5rem 0;
            }
        }

        /* Ensure proper spacing and layout */
        .demo-field-card {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }

        .form-actions {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
    </style>
</body>
</html>